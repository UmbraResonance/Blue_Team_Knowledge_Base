# Windows Event Core Deep-Dive

> [!TIP]
> **Priority Strategy:** Focus on P0 (Execution/Auth) for daily hunting. Use Category 0 (Integrity) to verify your visibility.

## Category 0: Defense Integrity

*Purpose: Ensuring the "Security Cameras" are not tampered with.*

### Event 4907: Object Audit Policy Changed
* **Priority:** High Impact / Low Frequency (Defense Evasion)
* **Adversary Intent:** Defense Evasion (TA0005). Specifically targeting Impair Defenses: Disable Windows Event Logging (T1562.002). Advanced actors modify SACLs to "silence" audit logs before accessing sensitive objects (e.g., lsass.exe, NTDS.dit, or Registry Keys).
* **Key Fields to Analyze:**
    - SubjectUserName: Who performed the change? (Suspicious if not a known Admin/System account).
    - Object Name: Which sensitive path was silenced?
    - Security Descriptor (SDDL): The core string describing the audit change.
* **SDDL Analysis Tip (SACL Focus):**
    - Specifically monitor for the removal of SA (Success) or FA (Failure) flags in the S:(AU;...) string.
    - Example: If (AU;SAFA;...;WD) is changed, the attacker has disabled auditing for "Everyone" (WD).
* **Reference:** [8.1.1_Object_Security_SACL](../08_Underlying_Principles/8.1_WIndows_Internals/8.1.1_Object_Security_SACL.md) (Mechanism of SACL modification)

### Event 1102: The Audit Log Was Cleared

* **Priority:** Critical Impact / Low Frequency
* **Adversary Intent:** Defense Evasion (TA0005). Attackers wiping tracks after compromise.
* **Logic:** This event should NEVER happen in a healthy environment.
* **Key Fields to Analyze:** 
    - SubjectUserSid (Who wiped it?).

---

## Category 1: Execution & Lineage (P0)

*Purpose: Catching the act of execution.*

### Event 4688: New Process Created

* **Priority:** Critical Impact / High Frequency
* **Adversary Intent:** Cross-Tactic Execution Carrier. Primarily associated with Execution (TA0002), but serves as the visibility engine for Persistence, Privilege Escalation, and Credential Access.
* **Key Fields to Analyze:**
    - NewProcessName: Full path of the executable. Check for random strings or non-standard directories.
    - ParentProcessName: Critical for lineage. Verify against [1.2_Windows_Process_Genealogy](./1.2_Windows_Process_Genealogy.csv).
    - CommandLine: The primary source for identifying download cradles and obfuscation (e.g., Base64).
    - SubjectLogonId: Useful for correlating the process back to a specific login session (Event 4624).
* **Detection Logic (General Principles):**
    * **Lineage Check:** Flag illegal parents.
    * **Command Line Audit:** Analyze the `CommandLine` field for obfuscation (Base64), download cradles, or LoLBin abuse.
    * **Path Anomaly:** Monitor executions from writable directories (`\Temp`, `\Public`, `\PerfLogs`).
* **Reference:** For specific threat mappings (e.g., Mimikatz, Certutil), see [1.1_Master_Hunting_Matrix](./1.2_Windows_Process_Genealogy.csv).

## Event 4648: A Logon Was Attempted Using Explicit Credentials

* **Priority: High Impact / Medium Frequency**
* **Adversary Intent:** Lateral Movement (TA0008) / Defense Evasion (TA0005).
* **Mechanism:** This is triggered by runas.exe or C2 frameworks (Cobalt Strike make_token, spawnas) creating a process with different credentials than the current user.
* **Key Fields to Analyze:**
    - SubjectUserName (The Attacker): The account currently running the malicious process.
    - TargetUserName (The Victim/Target): The account they are trying to become (e.g., Administrator).
    - ProcessName (The Weapon): The process requesting the new credential.
        - Suspicious: cmd.exe, powershell.exe, rundll32.exe.
        - Benign: mstsc.exe (RDP), explorer.exe (Mapping drives).
    - TargetServerName: If this is not localhost, they are moving laterally to another machine.
* **Detection Logic (General Principles):**
    - Process Lineage is King: This event is the "smoke"; the "fire" is the parent process. Do not just alert on the event; investigate the ProcessName field.
    - The "Unexpected Parent" pattern: Normal 4648s come from explorer.exe (user mapping a drive). Malicious 4648s typically originate from cmd.exe, powershell.exe, or rundll32.exe. Focus your triage on these high-risk parents. 
* **Reference:** [1.2_Windows_Process_Genealogy](./1.2_Windows_Process_Genealogy.csv) (Trace the Parent Process of this event to find the patient zero).

## Sysmon Event 7: Image Loaded

* **Priority:** Medium Impact/ High Frequency (Contextual P1 for critical processes)
* **Adversary Intent:** **Defense Evasion (TA0005).** Primarily used for DLL Side-Loading, DLL Search Order Hijacking, and Code Signing subversion.
* **Key Fields to Analyze:**
    - Image: The process performing the load.
    - ImageLoaded: Full path of the DLL. Focus on writable paths (`\Temp`, `\AppData`).
    - Signed: Boolean status of the digital signature.
    - Signature: The name of the signer. Critical for spotting "irrelevant" or mismatched certs.
    - SignatureStatus: Status (Valid, Invalid, Expired).
* **Detection Logic (General Principles):**
    - Context Mismatch: Identify DLLs where `Signed=true` but the vendor is unrelated to the process (e.g., `explorer.exe` loading a DLL signed by a random trading company).
    - Unsigned in System Process: Alert on any unsigned DLL loaded by critical processes like `lsass.exe` or `csrss.exe`.
    - Path Anomaly: Monitor processes loading DLLs from user-writable directories (\AppData, \Temp, \Public).
    - Specific Red Flag: .NET Injection Indicator
        - Trigger: Loading of clr.dll and clrjit.dll in native (non-managed) processes.
        - Significance: High-confidence indicator of Execute-Assembly or Reflective .NET Loading.
        - Focus Processes: svchost.exe, werfault.exe, spoolsv.exe, notepad.exe.
* **Reference:** [8.1.3_Authenticode_Verification](../08_Underlying_Principles/8.1_WIndows_Internals/8.1.3_Authenticode_Certificate_Chain_Verification.md) (Underlying chain of trust logic).

### Sysmon Event 10: Process Access

* **Priority:** Critical Impact / High Frequency
* **Adversary Intent:** Credential Access (TA0006) / Injection (TA0004). Often used for LSASS memory dumping.
* **Key Fields to Analyze:**
    - SourceImage: The actor process.
    - TargetImage: The victim process (e.g., lsass.exe).
* **Detection Logic**
    - CallTrace: **The "UNKNOWN" Pattern.** Flag entries pointing to memory regions not backed by disk files (indicates shellcode/reflective loading).

---

## Category 2: Authentication

*Purpose: Identifying Lateral Movement.*

### Event 4624: Success Logon

* **Priority:** Critical Impact / High Frequency
* **Adversary Intent:** Lateral Movement (TA0008) / Persistence (TA0003). Identifying how a user logged in (Logon Type) is the primary method for distinguishing legitimate admin activity from an attacker moving through the network.
* **Key Fields to Analyze:**
    - Logon Type:
        - Type 2 (Interactive): Local keyboard/screen access.
        - Type 3 (Network): Accessing shared folders, printers, or PsExec/WMI. (High volume, high value).
        - Type 10 (RemoteInteractive): RDP access.
    - WorkstationName / SourceNetworkAddress: Where did they come from? (Look for non-standard admin workstations).
    - ProcessName: What process initiated the logon? (e.g., advapi is normal, but strange binaries here are suspicious).
    - TargetUserName: Who is being impersonated?
* **Detection Logic (General Principles):**
    - RDP Anomalies: LogonType=10 AND SourceNetworkAddress != Internal Admin Subnets.
    - Lateral Movement: LogonType=3 AND TargetUserName == "Admin" AND SourceNetworkAddress != Domain Controller.
    - Pass-the-Hash: Monitoring for LogonType=3 combined with specific NTLM authentication packages (Event 4624 + Event 4776 anomalies).

### Event 4625: An Account Failed to Log On

* **Priority:** High Impact / High Frequency
* **Adversary Intent:** Credential Access (TA0006). High volumes indicate Brute Force, while low-and-slow patterns across multiple users indicate Password Spraying.
* **Key Fields to Analyze:**
    - Failure Reason (SubStatus): The "Why".
        - 0xC0000064: User Name does not exist (Enumeration).
        - 0xC000006A: Correct User, Wrong Password (Brute Force target).
        - 0xC0000234: Account Locked Out.
    - LogonType: The "Vector".
        - Type 3: SMB/Kerberos (Network Spraying).
        - Type 10: RDP (External Brute Force).
    - WorkstationName / SourceNetworkAddress: The "Source".
* **Detection Logic (Pattern Analysis):**
    - Brute Force: Same TargetUserName + High Count of 4625 + Same SourceNetworkAddress.
    - Password Spraying: Many distinct TargetUserName + Low Count per User + Single SourceNetworkAddress.
    - RDP Attack: LogonType=10 + SubStatus=0xC0000064 (Attacker guessing usernames).

### Event 4771: Kerberos Pre-Authentication Failed

* **Priority:** High Impact / High Frequency (Noise reduction required)
* **Adversary Intent:** Credential Access (TA0006).
    - Brute Force: Trying to guess passwords for a valid user.
    - Kerberoasting (CRITICAL): Requesting tickets with weak encryption (RC4) to crack offline.
* **Key Fields to Analyze:**
    - Failure Code (Status): The specific reason for failure.
        - 0x18 (Pre-auth failed): Wrong password. (Most common for Brute Force).
        - 0x6 (Client not found): User doesn't exist. (Username Enumeration).
        - 0x12 (Account disabled/expired): Attacker targeting old accounts.
    - TicketEncryptionType: The encryption algorithm used.
        - 0x17 (RC4-HMAC): RED FLAG. Modern Windows uses AES (0x11/0x12). If you see 0x17, itâ€™s often an attacker forcing a downgrade or performing Kerberoasting.
    - TargetUserName: The account being attacked.
    - IpAddress: The source of the attack.
* **Detection Logic:**
    - Encryption Mismatch: Focus on finding tickets requested with RC4 (0x17) encryption. In a modern domain (AES default), this specific pattern strongly implies a Kerberoasting attempt or a legacy misconfiguration, rather than a simple wrong password.
    - Volume Analysis: A single 4771 is noise; a burst of 4771s from one IP against many users is a spray.
* **Reference:** [1.4_Network_Protocol_Filters](./1.4_Network_Protocol_Filters.csv) (Compare with NTLM 4625).

### Event 4769: A Kerberos Service Ticket was Requested

* **Priority:** High Impact / High Frequency (Requires Noise Filtering)
* **Adversary Intent:** Credential Access (TA0006) - Kerberoasting. Attackers request these tickets to extract the service account's encrypted hash for offline cracking.
* **Key Fields to Analyze:**
    - **Service Name:** The SPN being targeted. Focus on accounts that are NOT machine accounts (those not ending in `$`).
    - **Ticket Encryption Type:** - `0x17` (RC4-HMAC): **CRITICAL RED FLAG.** Indicates a downgrade attempt or legacy weakness.
        - `0x11`/`0x12` (AES): Modern standard, much harder to crack.
    - **Ticket Options:** Look for `0x40810000` (Default Rubeus/Mimikatz flags).
    - **IpAddress:** The source of the request.
* **Detection Logic (The "Anti-Rubes" Strategy):**
    - **The Honey SPN Trap:** Create a decoy SPN (e.g., `MSSQLSvc/BackupAdmin`). Alert immediately if `ServiceName` matches this decoy.
    - **Encryption Downgrade:** Filter out machine accounts and alert on any `TicketEncryptionType=0x17`.
    - **Threshold Monitoring:** Monitor for a single `IpAddress` requesting an unusual number of unique `ServiceName` values within 1-5 minutes.
* **Reference:** [8.2.6_Kerberos_Protocol_and_Encryption](../08_Underlying_Principles/8.2_Active_Directory/8.2.6_Kerberos_Protocol_and_Encryption.md) (Deep dive into S2K and Enc-Part logic).

---

## Category 3: System & Service Operations

*Purpose: Catching state changes that allow code to run automatically (Persistence) or with higher privileges.*

### Event 4698: A Scheduled Task Was Created

* **Priority:** High Impact / Medium Frequency
* **Adversary Intent:** Persistence (TA0003) / Execution (TA0002).
* **Key Fields to Analyze:**
    - TaskName: Often obscured or mimics Windows tasks.
    - TaskContent (XML): The most important field. It contains the <Command> (what runs) and <Arguments> (flags).
* **Detection Logic (Pattern Analysis):**
    - Suspicious Command: Task XML contains powershell, cmd, rundll32, or regsvr32.
    - Temp Execution: Task executes a binary from \AppData\Local\Temp.
* **Reference:** [1.5_Forensics_Artifacts_Map](./1.5_Forensics_Artifacts_Map.csv) (Correlate with disk artifacts in C:\Windows\System32\Tasks).

### Event 7045: A Service Was Installed
* **Priority:** Critical Impact / Low Frequency
* **Adversary Intent:** Persistence (TA0003) / Privilege Escalation (TA0004). Attackers install services to ensure malware survives reboot or runs as SYSTEM.
* **Key Fields to Analyze:**
    - ServiceName: Name of the service. (Look for random strings like Xyza.exe or mimicry like WindowsUpdateHelper).
    - ImagePath: The binary path. CRITICAL: Look for paths in writable user directories (\Temp, \Users, \ProgramData) instead of System32.
    - ServiceType: Kernel Mode Driver implies a Rootkit; User Mode Service implies standard malware.
* **Detection Logic:**
    - Path Anomaly: ImagePath contains "Temp" OR "AppData" OR "PerfLogs".
    - Masquerading: ServiceName mimics a legitimate service but runs from a non-standard path.
* **Reference:** [1.2_Windows_Process_Genealogy](./1.2_Windows_Process_Genealogy.csv) (Verify if services.exe behavior matches).

### Event 4672: Special Privileges Assigned to New Logon

* **Priority:** Medium Impact / High Frequency (Contextual)
* **Adversary Intent:** Privilege Escalation (TA0004). This event tells you "Did they become God?"
* **Key Fields to Analyze:**
    - SubjectUserName: The account that logged in.
    - PrivilegeList: The specific powers granted.
    - Standard Admin Privs: SeSecurityPrivilege, SeBackupPrivilege.
    - Dangerous Privs (HUNT HERE):
        - SeDebugPrivilege: Allows dumping memory (e.g., extracting passwords from LSASS).
        - SeTcbPrivilege: Act as part of the operating system.
        - SeLoadDriverPrivilege: Ability to load kernel drivers (BYOVD attacks).
* **Detection Logic:**
    - The "God Mode" Check: Ignore the standard noise from System/Machine accounts. Review the PrivilegeList field specifically for SeDebugPrivilege and SeLoadDriverPrivilege.
    - Contextual Pivot: Once a suspicious user is found here, immediately cross-reference their Session ID (LogonID) with Event 4624 to identify the source IP address.

### Sysmon Event 13: Registry Value Set

* **Priority:** High Impact / Medium Frequency
* **Adversary Intent:** Persistence (TA0003) / Defense Evasion (TA0005).
    - Fileless Malware: Storing the *payload* (Shellcode/Script) inside a registry key to avoid file scanning (AV/EDR).
    - Persistence: Adding a new entry to `CurrentVersion\Run` or `RunOnce`.
* **Key Fields to Analyze:**
    - TargetObject: The registry key path.
        - *Persistence:* `\Software\Microsoft\Windows\CurrentVersion\Run`
        - *Fileless Storage:* Often obscure keys like `\Software\Classes\CLSID\{GUID}` or purely random keys in `HKCU`.
    - Details (CRITICAL): The actual data being written.
    - Image: The process performing the write (e.g., `powershell.exe` writing to Registry is suspicious).
* **Detection Logic (Pattern Analysis):**
    - **Data Size and Entropy Anomalies:**
        - Legitimate registry values are typically short configuration strings or small integer types (DWORD/QWORD).
        - Indicator: Identify registry write events where the `Details` field contains a large volume of data (e.g., >1KB). If the data exhibits high entropy (randomness indicative of encrypted/compressed content) or contains executable file headers (e.g., hex starting with `4D 5A`), it likely represents a stored binary payload or shellcode.
    - Script Engine and Obfuscation Artifacts:
        - Even if the payload is encoded, the execution method often requires specific script engine arguments.
        - Indicator: Inspect the `Details` field for strings associated with script execution wrappers, such as `powershell`, `-enc` (Base64 encoded command), `javascript`, `vbscript`, `rundll32`, or `mshta`.
    - Binary Header Mismatch:
        - Indicator: Detect instances where binary executable data (identified by the `MZ` header) is written to registry keys that are not designed to store binary blobs (e.g., `HKCU` or `HKCR` configuration keys), regardless of the registry value name.
* **Reference:** [1.5_Forensics_Artifacts_Map](../01_Hunting_Cheatsheets/1.5_Forensics_Artifacts_Map.csv) (Compare with native Autoruns artifacts).

---

## Category 4: Network Operations

*Purpose: Identifying Lateral Movement & Data Staging.*

### Event 5142: A Network Share Object Was Added

* **Priority:** High Impact / Low Frequency
* **Adversary Intent:** Lateral Movement (TA0008) / Collection (TA0009). Attackers create new shares to move malware between hosts or to stage sensitive data before exfiltration.
* **Key Fields to Analyze:**
    - SubjectUserName: Who created the share? (Suspicious if it's not a Service Account or Admin).
    - Share Name: Is it a hidden share (ending in $)?
    - Share Path: Where does the share point to? (e.g., C:\Users\Public or C:\Windows\Temp).
* **Detection Logic:**
    - Baseline Anomaly: Alert on any 5142 generated on non-File Server hosts (e.g., Finance or HR workstations).
    - Flag any 5142 event where the `Share Path` points to OS-critical or data-sensitive directories.
        - **System Root:** `C:\Windows`, `C:\Windows\System32`, `C:\Windows\SysWOW64`.
        -  **Root Drives:** `C:\` (Creating a new share for the entire system drive is highly anomalous).
        - **User Staging:** `C:\Users\<User>\Documents`, `C:\Users\Public`.
        - **Web Servers:** `C:\inetpub\wwwroot` (Potential web shell deployment or source code theft).
        - **Temporary/Common Staging:** `C:\Temp`, `C:\Windows\Temp`, `C:\ProgramData`.
    - Command Line Correlation: Pivot to Event 4688 using SubjectLogonId to find the process that ran net share or New-SmbShare.

---

## Category 5: File & Object Operations

### Event 4656 & 4663: The Object Access Chain

* **Priority:** Medium Impact / Forensic Support (P2)
* **Adversary Intent:** Collection (TA0009) / Credential Access (TA0006). Records the lifecycle of an interaction with a System Object (File, Registry, or Process).
* **Key Fields to Analyze:**
    - **Object Type:** Identifies if the target is a File, Key, or Process.
    - **Access Mask:** Decodes the "Verb" (e.g., `0x1` = ReadData, `0x2` = WriteData, `0x10` = ReadControl).
    - **Handle ID:** The unique session token used to correlate the request (4656) with the actual operation (4663).
* **Detection Logic:**
    - **Handle Correlation:** Do not alert on 4656 alone; use the `Handle ID` to pivot and find the corresponding 4663 to confirm successful access.
    - **Cross-Category Pivot:** Use the `SubjectLogonId` to link these object operations back to the original `4624` Logon event to identify the source IP.

---

## Appendix: Detection Priority Matrix

*Purpose: To standardize the classification of Event IDs based on their operational impact and observation frequency during an investigation.*

### 1. Classification Framework

| Priority Level | Impact (Severity) | Frequency (Visibility) | Description & Logic |
| :--- | :--- | :--- | :--- |
| **P0: Critical** | **High** | **High** | **Core Detection Pipeline.** Events that record the primary actions of an adversary (Execution, Auth). Mandatory for baseline monitoring. |
| **P1: Warning** | **High** | **Low** | **Defense Evasion / Integrity.** Events indicating tampering with security controls or auditing policy changes (e.g., Event 4907). |
| **P2: Informational** | **Medium** | **Varies** | **Forensic Support.** Supplemental logs used for deep-dive root cause analysis and reconstructing specific object access history. |

### 2. Priority Determination Workflow

To maintain consistency when adding new Event IDs, evaluate them against these three criteria:

1.  **Choke Point Analysis:** Is this event part of an adversary's mandatory path (e.g., Process Start)? 
    * *Yes* -> **High Impact**.
2.  **Noise Floor Evaluation:** Does this event generate millions of logs daily under normal conditions (e.g., File Read)? 
    * *Yes* -> **Medium/High Frequency**.
3.  **Adversarial Focus:** Is this event typically generated when an attacker tries to hide their tracks? 
    * *Yes* -> **P1: Warning (Low Frequency)**.
