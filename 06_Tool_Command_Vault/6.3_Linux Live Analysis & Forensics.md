# 6.3 Linux Live Analysis & Forensics

> **Focus:** Live triage and artifact analysis using native Linux binaries.
> **Context:** Unlike Windows, Linux forensics relies heavily on text processing (`grep`, `awk`) rather than specialized parsers.
> **Note:** Run as **root** (sudo -i).

---

## User Activity & Logins (The "Who")

### Login History (Binary Logs)

*Evidence: Successful/Failed logins and reboots. Parses `/var/log/wtmp` and `/var/log/btmp`.*

**Check successful logins (wtmp):**
```bash
last -f /var/log/wtmp | head -n 20
# Shows: User, TTY, Source IP, Login Time
```

**Check failed login attempts (btmp - Brute Force):**
```bash
lastb -f /var/log/btmp | head -n 20
# or count attempts by IP:
lastb | awk '{print $3}' | sort | uniq -c | sort -nr
```

### Auth Logs (Text Logs)

*Evidence: SSH keys added, sudo usage, user creation. Granular authentication steps. Critical if wtmp is deleted.*
- Debian/Ubuntu: `/var/log/auth.log`
- RHEL/CentOS: `/var/log/secure`

**Successful SSH Logins (Public Key/Password):**
```bash
grep -E "Accepted publickey|Accepted password" /var/log/auth.log
```

**Session Lifecycle:** Even if `last` is wiped, PAM logs the session open event.
```bash
# Find when a user shell was spawned
grep "session opened" /var/log/auth.log
# Output: "pam_unix(sshd:session): session opened for user root..."
```

**Systemd Logind Sessions:** Modern Linux tracking of user sessions.
```bash
grep "systemd-logind" /var/log/auth.log | grep "New session"
```

**New User Creation:**
```bash
grep "new user" /var/log/auth.log
```

### Command History

*Evidence: What did the attacker execute?*

**Check current user's history:**
```bash
history 
# Note: Attackers often disable this or run 'history -c'.
```

**Check history files for all users:**
```bash
grep -r "sudo" /home/*/.bash_history
cat /root/.bash_history
```

## Persistence

### Cron Jobs (Scheduled Tasks)

*Evidence: Malware running periodically.*

**Check all user crontabs:**
```bash
for user in $(cut -f1 -d: /etc/passwd); do echo "--- $user ---"; crontab -u $user -l; done
```

**Check system-wide cron directories:**
```bash
ls -la /etc/cron*
cat /etc/crontab
```

### Systemd Services

*Evidence: Malicious services starting at boot.*

**List all running services:**
```bash
systemctl list-units --type=service --state=running
```

**Find recently created/modified service files:**
```bash
# Look for service files modified in the last 7 days
find /etc/systemd/system/ -mtime -7 -type f
```

### SSH Keys (Backdoors)

*Evidence: Attacker added their key to authorized_keys to bypass passwords.*

**Audit all authorized_keys files:**
```bash
find /home/ -name "authorized_keys" -exec echo "File: {}" \; -exec cat {} \;
# Action: Look for unknown keys or keys with suspicious comments (e.g., "kali").
```

## File System & Timestamps

### File Metadata

*Evidence: Check MAC times (Modify, Access, Change).*

**Get detailed file metadata:**
```bash
stat <SUSPICIOUS_FILE>
# Example: stat /tmp/malware.sh
```

### Hunting by Time

*Evidence: Find all files modified during the incident window.*

**Find files modified in the last 2 days:**
```bash
find / -mtime -2 -type f 2>/dev/null
```

**Find files newer than a specific timestamp (Precision Hunt):**
```bash
# 1. Create a reference file with the incident start time (YYYYMMDDhhmm)
touch -t <YYYYMMDDhhmm> /tmp/ref_start
# 2. Find files created/modified after that time
find / -newer /tmp/ref_start
```

### Hunting by Attributes

*Evidence: Finding hidden files or executables in non-standard directories.*

**Find executables in temporary folders (Classic Malware):**
```bash
find /tmp /var/tmp /dev/shm -type f -executable
```

**Find Immutable files (Rootkit Tactic): Attackers make files undeletable (even by root) using `chattr +i`.**
```bash
lsattr -R / 2>/dev/null | grep "\-i\-"
```

## Network & Processes (Live State)

### Open Connections

*Evidence: C2 Beaconing or Reverse Shells.*

**List connections with Process ID (PID):**
```bash
netstat -antup
# OR (if netstat is missing)
ss -antup
```

### Process Investigation

*Evidence: Hidden processes or masquerading binaries.*

**Visual Process Tree:**
```bash
ps -ef --forest
# Look for logic gaps: e.g., 'apache2' spawning 'bash'.
```

**Recover Deleted Binary from Memory:** If attacker ran `./malware` then `rm malware`, the code is still in RAM.
```bash
# 1. Find PID of running malware
ps -ef | grep malware
# 2. Recover from /proc
cp /proc/<PID>/exe /tmp/recovered_malware_sample
```

## Web Log Analysis (Apache/Nginx)

*Evidence: WebShell upload, SQL Injection, Local File Inclusion (LFI). Default Paths: `/var/log/apache2/access.log` or `/var/log/nginx/access.log`*

### Quick Triage

**Top User Agents (Spotting scanners/tools):**
```bash
awk -F\" '{print $6}' access.log | sort | uniq -c | sort -nr | head
```

**Top Requesting IPs:**
```bash
awk '{print $1}' access.log | sort | uniq -c | sort -nr | head
```

### Attack Pattern Hunting

**Find Webshell Uploads (POST requests to .php or .jsp):**
```bash
grep "POST" access.log | grep -E "\.php|\.jsp|\.sh"
```

**Find Command Injection / LFI:**
```bash
grep -E "etc/passwd|whoami|cat |base64" access.log
```