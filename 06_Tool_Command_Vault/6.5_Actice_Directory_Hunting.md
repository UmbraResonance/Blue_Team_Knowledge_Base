# Active Directory Hunting

> **Focus:** Leveraging the ActiveDirectory PowerShell module and specialized queries for Domain-wide TTPs.
> **Use Case:** Identifying persistence, privilege escalation, and historical identity overlaps.

---

## 0. Environment Baseline: Domain Functional Level (DFL) Assessment

Before executing specific hunting queries, identify the "Defense Ceiling" of the current environment. The DFL dictates which modern security features are available to the blue team and which legacy weaknesses remain exploitable for attackers.

### 0.1 Enumeration Command
```powershell
# Identify the current Domain Functional Level
Get-ADDomain | Select-Object Name, DomainMode
```

### 0.2 Hunting & Strategy Matrix (Based on DFL)

| DFL Mode | Security Implications (The "Why") | Tactical Hunting Focus |
| :--- | :--- | :--- |
| **< Windows 2008** | **Legacy Risk**: No support for AES encryption in Kerberos by default. | Focus on **RC4-HMAC (Type 0x17)** ticket encryption in Event 4769. High probability of successful Kerberoasting. |
| **Windows 2012 R2** | **Credential Shield**: Introduction of the `Protected Users` Security Group. | Check if high-privilege accounts are members of this group. If not, prioritize hunting for **LSASS memory dumping** or NTLM relaying. |
| **Windows 2016** | **Granular Control**: Supports `Authentication Policy Silos` and `Temporary Group Memberships`. | Hunt for **Silo bypasses** or anomalies in ephemeral group additions (Potential JIT elevation abuse). |

### 0.3 Critical Defensive Triggers
* **IF DFL < 2012 R2**: Assume credentials are highly vulnerable to local harvesting. Focus hunting on lateral movement via NTLM.
* **IF DFL >= 2012 R2**: Verify if the `Protected Users` group is actually utilized. The presence of Domain Admins *outside* this group is a high-confidence finding for risk assessment.

## 1. Identity Archaeology (sIDHistory Resolution)

*Use Case: Auditing sIDHistory to find legacy identities or potential SID Injection.*

```powershell
# Resolve sIDHistory to current accounts to find "Shadow Identities"
Get-ADUser -Filter 'sidhistory -like "*"' -Properties sidHistory | ForEach-Object {
    $User = $_
    foreach ($sid in $User.sidHistory) {
        try {
            $sidObject = New-Object System.Security.Principal.SecurityIdentifier($sid.Value)
            $resolved = $sidObject.Translate([System.Security.Principal.NTAccount]).Value
        } catch {
            $resolved = "Orphaned SID"
        }
        [PSCustomObject]@{
            SamAccountName   = $User.SamAccountName
            HistoricalSID    = $sid.Value
            ResolvedIdentity = $resolved
        }
    }
} | Sort-Object SamAccountName
```

## 2. Governance Auditing (AdminSDHolder & adminCount)

*Use Case: Detecting stale privileged markers or unauthorized self-healing exclusions.*

```powershell
# Find users with adminCount=1 who are NOT currently in critical groups
Get-ADUser -Filter 'adminCount -eq 1' -Properties memberOf | Where-Object {
    $_.memberOf -notmatch "Domain Admins|Enterprise Admins|Schema Admins"
} | Select-Object Name, SamAccountName, memberOf
```

## 3. Schema and Configuration Mining

*Use Case: Identifying non-default forest-wide settings.*

```powershell
# Check dsHeuristics for List Object Mode or AdminSDHolder exclusions
Get-ADObject "CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,$((Get-ADRootDSE).configurationNamingContext)" -Properties dsHeuristics | 
Select-Object DistinguishedName, dsHeuristics
```

## 4. Master Browser Detection (Legacy Protocol Hunting)

*Use Case: Identifying the Master Browser for potential SMB v1 / NBNS poisoning surface.*

```powershell
# Use nbtstat to find the __MSBROWSE__ [01h] marker
nbtstat -A <DC_IP_ADDRESS>
```