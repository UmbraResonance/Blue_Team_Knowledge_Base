# PowerShell Get-WinEvent Hunting Syntax

> **Focus:** Syntax templates for native Windows Event Log analysis.
> **Use Case:** Building high-performance queries for Live Response or Offline Forensics.
> **Legend:** Replace values inside `<...>` with your specific requirements.

---

## 1. Core Filtering Syntax (FilterHashtable)

*Standard structure for high-performance server-side filtering. Always prefer this over `Where-Object` for initial selection.*

### Basic Event ID Filter

```powershell
Get-WinEvent -FilterHashtable @{
    LogName = '<LOG_NAME>'
    ID      = <EVENT_ID>
}
# Example LogNames: Security, System, Application, Microsoft-Windows-Sysmon/Operational
```

*Use these exact names in the `LogName` parameter. Do not use abbreviations.*

| Common Name | Exact LogName (Copy this) | Description |
| :--- | :--- | :--- |
| **Security** | `'Security'` | Authentication, Process Creation (4688), and Audit Policy changes. |
| **System** | `'System'` | Service Control Manager (SCM), Reboots, and Driver loads. |
| **Application** | `'Application'` | General application errors and crashes. |
| **Sysmon** | `'Microsoft-Windows-Sysmon/Operational'` | Advanced telemetry (Process lineage, Network, DNS). |
| **PowerShell** | `'Microsoft-Windows-PowerShell/Operational'` | Modern PowerShell logs (Script Block logging, Module loads). |
| **PS (Legacy)** | `'Windows PowerShell'` | Older PowerShell engine logs (Pre-PS v5). |
| **Defender** | `'Microsoft-Windows-Windows Defender/Operational'`| Windows Defender Antivirus detections and scans. |

*Or use the following command to find the LogName alernatively*
```powershell
Get-WinEvent -ListLog *<Keyword>* | Select-Object LogName
```

### Time-Based Filter

*Query logs within a specific recent timeframe.*

```powershell
Get-WinEvent -FilterHashtable @{
    LogName   = '<LOG_NAME>'
    StartTime = (Get-Date).AddHours(-<HOURS>)
}
```

*Query logs within a defined timeframe with absolute time range*

```powershell
Get-WinEvent -FilterHashtable @{
    LogName   = '<LOG_NAME>'
    StartTime = "YYYY-MM-DD HH:MM:SS"
    EndTime   = "YYYY-MM-DD HH:MM:SS"
    # Time used here is local machine's time, sometimes you need to convert it from UTC time.
}
```

### Combined Filter (ID + Time)

*The most common hunting pattern.*

```powershell
Get-WinEvent -FilterHashtable @{
    LogName   = '<LOG_NAME>'
    ID        = <EVENT_ID>
    StartTime = (Get-Date).AddMinutes(-<MINUTES>)
} | Select-Object TimeCreated, Id, Message | Format-Table -AutoSize
```

### Filtering by Specific Property (e.g., Logon Type)

*Filter based on indexed properties (Data field) inside the event.*

```powershell
Get-WinEvent -FilterHashtable @{LogName='<LOG_NAME>'; ID=<EVENT_ID>} | 
Where-Object { $_.Properties[<INDEX>].Value -eq <VALUE> }
# Common Indexes for Event 4624:
# [8] = Logon Type (e.g., 2, 3, 10)
# [5] = Account Name
# [18] = Source IP Address
```
*Discover property index ID with the following command*

```powershell
$Event = Get-WinEvent -LogName Security -Id <EVENT_ID> -MaxEvents 1
for ($i=0; $i -lt $Event.Properties.Count; $i++) {
    [PSCustomObject]@{
        Index = $i
        Value = $Event.Properties[$i].Value
    }
}
```

---

## 2. String & Pattern Hunting (Client-Side)

*Use when searching for non-indexed data (keywords, filenames, command lines) within the Message field.*

### Keyword Search (Message Field)

```powershell
Get-WinEvent -FilterHashtable @{LogName='<LOG_NAME>'; StartTime=(Get-Date).AddDays(-<DAYS>)} | 
Where-Object { $_.Message -like "*<KEYWORD>*" } | 
Select-Object TimeCreated, Id, Message
```

### Multiple Keyword Logic

```powershell
Get-WinEvent -FilterHashtable @{LogName='<LOG_NAME>'; ID=<EVENT_ID>} | 
Where-Object { $_.Message -like "*<KEYWORD_1>*" -or $_.Message -like "*<KEYWORD_2>*" }
```

---

## 3. Offline Log Analysis (.evtx)

*Syntax for analyzing exported log files from other systems.*

### Parse Single EVTX File

```powershell
Get-WinEvent -Path "<PATH_TO_EVTX_FILE>" | 
Select-Object TimeCreated, Id, Message -First <NUMBER>
```

### Bulk Search in Directory

*Recursively search all .evtx files in a folder for a specific Event ID.*

```powershell
Get-ChildItem "<DIRECTORY_PATH>\*.evtx" | ForEach-Object {
    Get-WinEvent -Path $_.FullName -FilterXPath "*[System[(EventID=<EVENT_ID>)]]" -ErrorAction SilentlyContinue
} | Select-Object TimeCreated, Id, Message
```

---

## 4. XML Data Extraction (Advanced)

### Advanced XML Data Extraction Framework

*Use Case: High-performance hunting when target telemetry exists within the non-indexed EventData or UserData fields of any Windows Event.*

```powershell
Get-WinEvent -FilterHashtable @{
    LogName = '<LOG_NAME>'      # e.g., 'System', 'Security', 'Microsoft-Windows-Sysmon/Operational'
    ID      = <EVENT_ID>        # e.g., 4624, 1, 3
} | ForEach-Object {
    $xml = [xml]$_.ToXml()
    $eventData = $xml.Event.EventData.Data
    New-Object PSObject -Property @{
        Timestamp = $_.TimeCreated
        # Generic pattern to extract value by attribute name
        <CUSTOM_FIELD_A> = $eventData | Where-Object {$_.Name -eq "<XML_FIELD_NAME_1>"} | Select-Object -ExpandProperty '#text'
        <CUSTOM_FIELD_B> = $eventData | Where-Object {$_.Name -eq "<XML_FIELD_NAME_2>"} | Select-Object -ExpandProperty '#text'
    }
} | Where-Object { $_.<CUSTOM_FIELD_A> -like "*<PATTERN>*" }
```

---

## 5. GUI & Output Formatting

*Helpers for visualization.*

### Interactive Grid View

```powershell
<QUERY_COMMAND> | Select-Object TimeCreated, Id, LevelDisplayName, Message | Out-GridView
```

### Export to CSV

```powershell
<QUERY_COMMAND> | Select-Object * | Export-Csv "<OUTPUT_PATH>.csv" -NoTypeInformation
```
