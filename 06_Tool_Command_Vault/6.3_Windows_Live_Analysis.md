# 6.3 Windows Live Analysis (Triage)

> **Focus:** Live response via RDP/Shell on a running system.
> **Goal:** Identify "low hanging fruit" (persistence, active C2) *before* full forensic acquisition.
> **Context:** Use when you cannot take the system offline or need immediate answers.
> **Note:** Run PowerShell/CMD as **Administrator**.

---

## Network Connections

*Goal: Find the malware beaconing home.*

### Basic (CMD)

*Quick check for established connections.*

```cmd
netstat -ano | findstr "ESTABLISHED"
# Action: Note the PID (Process ID) on the far right.
```

### Advanced (PowerShell)

*Correlate connection to Process Name immediately.*

```powershell
# List all TCP connections with owning process info
Get-NetTCPConnection | Select-Object LocalAddress, LocalPort, RemoteAddress, RemotePort, State, OwningProcess, @{Name="Process";Expression={(Get-Process -Id $_.OwningProcess).ProcessName}} | Format-Table -AutoSize
```

### DNS Cache

*What domains has this machine resolved recently?*

```cmd
ipconfig /displaydns | findstr "Record"
```

## Process Analysis

*Goal: Find the malware running in memory.*

### Basic (CMD)

*Verbose list to see the user running the process.*

```cmd
tasklist /v
# Look for: "svchost.exe" running as a normal User (Should be SYSTEM/NETWORK SERVICE).
```

### Advanced (PowerShell)

*Calculate Hash of running processes for VirusTotal check.*

```powershell
Get-WmiObject Win32_Process | Select-Object Name, CommandLine | Format-List
```

### Process Command Lines

*Spot the arguments (e.g., base64 strings).*

```powershell
Get-WmiObject Win32_Process | Select-Object Name, CommandLine | Format-List
```

## User & Account Anomalies

*Goal: Find backdoors created by the attacker.*

### Basic (CMD)

```cmd
# List users
net user

# Check Local Admins (Did they add themselves?)
net localgroup administrators
```

### Advanced (PowerShell)

```powershell
# Check for users with passwords set recently (if AD module not available, check LastLogon)
Get-LocalUser | Select-Object Name, Enabled, LastLogon, PasswordLastSet

# Check who is logged in RIGHT NOW
qwinsta
```

## Persistence Mechanisms

*Goal: Find how the malware survives a reboot.*

### Scheduled Tasks

```cmd
schtasks /query /fo LIST /v | findstr "TaskName Status"
# Look for random names or tasks running from \Temp
```

### Services

*Filter out the noise (Microsoft signed services).*

```powershell
# List 'Running' services that are NOT from "C:\Windows\" (High noise filter, but effective)
Get-WmiObject Win32_Service | Where-Object { $_.State -eq 'Running' -and $_.PathName -notlike "*C:\Windows\*" } | Select-Object Name, DisplayName, PathName, StartMode
```

### Registry Run Keys

```cmd
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run
```

## Event Log Automation (DeepBlueCLI)

*Condition: If you can upload/download the script to the victim machine.*

**Run against LIVE logs:**
```powershell
# Analyze Security Log (Attacks, Logins)
.\DeepBlue.ps1 -log security

# Analyze System Log (Service creation)
.\DeepBlue.ps1 -log system
```

## One-Liner Collection Script (Panic Button)

```powershell
# Create an evidence folder
$dest = "C:\Evidence_$(get-date -f yyyyMMdd_HHmm)"; New-Item -ItemType Directory -Force -Path $dest

# 1. Export Process List
Get-Process | Select-Object * | Export-Csv "$dest\processes.csv" -NoTypeInformation

# 2. Export Network Connections
Get-NetTCPConnection | Export-Csv "$dest\network.csv" -NoTypeInformation

# 3. Export Services
Get-Service | Export-Csv "$dest\services.csv" -NoTypeInformation

# 4. Zip it up (Windows 10+)
Compress-Archive -Path $dest -DestinationPath "$dest.zip"

Write-Host "Evidence collected at $dest.zip" -ForegroundColor Green
```