# Windows Service Control Manager (SCM) and Named Pipes Communication

---

## 1. Overview
The **Service Control Manager (SCM)** and **Named Pipes** are fundamental Windows mechanisms that intersect during administrative tasks and lateral movement activities (e.g., PsExec). Understanding their underlying orchestration is critical for detecting service-based persistence and inter-process communication (IPC) anomalies.

---

## 2. Service Control Manager (SCM) Architecture
The SCM is a specialized Remote Procedure Call (RPC) server launched by `services.exe` during system boot. It acts as the "ledger" for all Windows services.

### Key Components:
* **The Database:** Maintained in the registry at `HKLM\SYSTEM\CurrentControlSet\Services`. Every service must have a subkey here.
* **Control Requests:** SCM handles requests to start, stop, and configure services via the Service Control API (e.g., `CreateService`, `StartService`).
* **Security Context:** Services typically run under `LocalSystem`, `NetworkService`, or `LocalService` accounts, making them high-value targets for privilege escalation.

---

## 3. Named Pipes: The Inter-Process Conduit
Named Pipes provide a method for one-way or duplex communication between a server process and one or more client processes. They allow processes to share data without the overhead of network sockets, even across a network using the SMB protocol (port 445).

### Communication Workflow:
1.  **Creation:** A server process creates a pipe using `CreateNamedPipe` with a specific name (e.g., `\\.\pipe\psexesvc`).
2.  **Connection:** A client process connects using `CreateFile` or `CallNamedPipe`.
3.  **Abuse Vector:** Because Named Pipes support impersonation, a malicious client can sometimes trick a privileged server into connecting to its pipe, leading to token theft.

---

## 4. Case Study: PsExec Orchestration
PsExec's effectiveness relies on the synergy between SCM and Named Pipes:

1.  **Service Deployment:** The PsExec client uses the SCM API to remotely create and start a service named `PSEXESVC` on the target machine.
2.  **Binary Execution:** The SCM executes `C:\Windows\PSEXESVC.exe` under the `SYSTEM` context.
3.  **I/O Redirection via Pipes:** To provide an interactive shell, `PSEXESVC.exe` creates named pipes (e.g., `\psexesvc-stdin`, `\psexesvc-stdout`). The local PsExec client connects to these pipes via SMB to send commands and receive output.

---

## 5. Detection & Hunting Indicators

| Artifact | Event Source | Event ID | Logic |
| :--- | :--- | :--- | :--- |
| **Service Creation** | System Log | 7045 | New service installation with suspicious ImagePath (e.g., `\Temp\`). |
| **Registry Modification** | Sysmon | 13 | `services.exe` modifying `ImagePath` in `CurrentControlSet\Services`. |
| **Pipe Creation** | Sysmon | 17 | Unusual processes creating named pipes (e.g., `\psexesvc`). |
| **Pipe Connection** | Sysmon | 18 | Cross-process communication between an untrusted process and a system pipe. |

---

## Conclusion
The SCM provides the **Execution** capability, while Named Pipes provide the **Communication** channel. Modern attackers often rename service binaries and pipe names to evade signature-based detection, making behavioral monitoring of `services.exe` and pipe-related Sysmon events essential for robust defense.

Beyond PsExec, SCM is the ultimate gatekeeper for high-privilege operations. Whether it's the exploitation of Unquoted Service Paths for elevation, or the tampering of EDR services for evasion, SCM telemetry (Event 7045/7036/13) remains the most reliable signal for identifying post-exploitation activities in a Windows environment.