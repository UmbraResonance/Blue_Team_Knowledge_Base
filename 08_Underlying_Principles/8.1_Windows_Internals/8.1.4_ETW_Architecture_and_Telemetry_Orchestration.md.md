# ETW Architecture & Telemetry Orchestration

## Overview

Event Tracing for Windows (ETW) is a high-performance, low-overhead debugging and tracing framework built into the Windows kernel. For Blue Teams, it is the primary source of Ground Truth Telemetry. Unlike static logs, ETW provides a real-time stream of system operations.

## The Four Pillars of ETW

The ETW ecosystem relies on four distinct roles working in tandem:

| Role | Responsibility |
| :--- | :--- | :--- |
| **Providers** | Components (Kernel/User) that generate events (e.g., `CodeIntegrity`). |
| **Controllers** | Applications that start/stop tracing sessions (e.g., `logman`, `wpr`). |
| **Sessions** | In-memory buffers that collect events from one or more Providers. |
| **Consumers** | Applications that read and process events (e.g., `Event Viewer`, `EDR`, `Splunk UF`). |

## The "Pre-Execution" Advantage

ETW is unique because many providers (like CodeIntegrity) hook into Kernel Functions (e.g., NtCreateSection). This allows the system to generate telemetry before a malicious action (like loading an unsigned driver) is completed.
* **Traditional Logs:** Often record what happened (Post-execution).
* **ETW Telemetry:** Often records what is being attempted (Pre-execution).

## Core Kernel Telemetry (Low-Level Persistence & Evasion)

### Core Kernel Telemetry (Low-Level Persistence & Evasion)

* **Microsoft-Windows-Kernel-Process**
    - Purpose: Monitors process creation, thread injection, and process hollowing.
    - Insight: Critical for detecting Parent PID (PPID) Spoofing. ETW records the actual parent process at the kernel level. By comparing this with the parent process claimed by the process itself, analysts can identify spoofing attempts instantly.
    - Key Keywords: 0x10 (Image), 0x20 (Thread).

* **Microsoft-Windows-Kernel-File**
    - Purpose: Tracks file creation, modification, deletion, and renaming.
    - Real-world Value: Detecting Ransomware encryption patterns or sensitive data exfiltration (e.g., a process unexpectedly reading thousands of small files).

* **Microsoft-Windows-Kernel-Network**
    - Purpose: Captures network connections before they hit the network stack.
    - Real-world Value: Identifying stealthy C2 communications that might bypass user-mode firewalls or monitoring tools.

* **Microsoft-Windows-Kernel-Registry**
    - Mechanism: Captures every read, write, and delete operation on the Windows Registry at the kernel level.
    - Security Value: Bypasses the limitations of standard Security 4657 logs. It is the ultimate tool for monitoring Persistence (T1543.003) by watching for modifications to service keys (HKLM\System\CurrentControlSet\Services) that bypass traditional management tools.

### Defense Integrity & Self-Protection

* **Microsoft-Windows-CodeIntegrity (CI)**
    - Mechanism: Enforces the Authenticode signature requirements for every binary (drivers and images) before execution.
    - Security Value: The primary telemetry source for detecting BYOVD (Bring Your Own Vulnerable Driver) and unauthorized DLL sideloading.
    - Key Events: 3004 (Validation Failure), 3089 (Signature Chain Details).

* **Microsoft-Windows-Security-Mitigations**
    - Mechanism: Tracks the application of Exploit Protection features like ACG (Arbitrary Code Guard), ASLR, and DEP.
    - Security Value: Detects 0-day exploit patterns. If a process (like a web browser) attempts to generate dynamic code in violation of its policy, this provider triggers a signal.

* **Microsoft-Antimalware-Service & Protection**
    - Mechanism: Monitors the status and health of the Windows Defender engine (MsMpEng.exe) and its detection hits.
    - Security Value: Detects "Defense Evasion" (T1562). If an attacker attempts to disable Defender services or add malicious exclusions, these providers capture the service state changes and configuration tampering.

### Remote Access & Lateral Movement

* **Microsoft-Windows-SMBClient / SMBServer**
    - Mechanism: Tracks file-sharing activity and remote IPC$ connections.
    - Security Value: Critical for detecting Lateral Movement (T1021.002) and unauthorized data staging. It records source IPs and the specific files being accessed over the network.

* **Microsoft-Windows-WinRM / OpenSSH**
    - Mechanism: Monitors remote management sessions via PowerShell Remoting (WinRM) or Secure Shell (OpenSSH).
    - Security Value: Tracks "Living off the Land" remote execution. OpenSSH telemetry is increasingly vital as more Windows environments adopt it for cross-platform management.

* **Microsoft-Windows-TerminalServices-LocalSessionManager**
    - Mechanism: Manages the lifecycle of RDP and local interactive sessions.
    - Key Events: 21 (Logon), 24 (Disconnect), 25 (Reconnect).
    - Security Value: Detecting RDP Session Hijacking. It captures re-connections that standard Security 4624 logs often miss.

* **Microsoft-Windows-VPN-Client**
    - Mechanism: Logs VPN tunnel establishment and teardown.
    - Security Value: Monitoring remote access integrity and identifying anomalous connection times or geographic locations for corporate VPN accounts.

### Runtime & Scripting (Memory-Only & Fileless Attacks)

* **Microsoft-Windows-DotNETRuntime**
    - Purpose: Logs .NET assembly loading, JIT compilation, and interop calls.
    - Insight: Vital for detecting tools like Cobalt Strike's execute-assembly. By using tools like SilkETW with keyword 0x2038, analysts can see the specific C# methods being called in memory (e.g., execute-assembly running Seatbelt.exe).
    - Key Field: ManagedInteropMethodName (often exposes the tool's true intent).

* **Microsoft-Windows-PowerShell**
    - Purpose: Provides deep visibility into PowerShell script block execution.
    - Real-world Value: Decrypts and logs obfuscated scripts at the time of execution, exposing fileless payloads.

### Infrastructure & Advanced Defense

* **Microsoft-Windows-Threat-Intelligence (TI)**
> **Note:** This is a Restricted Provider, typically requiring PPL (Protected Process Light) status for consumption.
    - Purpose: Provides hyper-detailed telemetry on process injection, memory allocation, and cross-process operations.
    - Value: This is the primary signal source for modern EDR engines to detect sophisticated injection techniques like Reflective DLL Injection.

* **Microsoft-Windows-DNS-Client**
    - Purpose: Logs all DNS resolution requests.
    - Real-world Value: Identifying C2 domains even when the adversary uses static IP addresses or pivots.

* **Microsoft-Windows-LDAP-Client**
    - Purpose: Monitors queries sent to Domain Controllers.
    - Insight: Detecting Active Directory Reconnaissance. Large-scale LDAP enumerations performed by tools like BloodHound or SharpHound leave distinct patterns here.