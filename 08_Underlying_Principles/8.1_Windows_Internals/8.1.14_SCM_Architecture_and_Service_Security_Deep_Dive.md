# SCM Architecture & Service Security Deep Dive

> **Core Principle**: The Service Control Manager (SCM) is the "Foreman" of the Windows operating system. It doesn't just run programs; it orchestrates the security context, privilege assignment, and lifecycle of every background process and kernel-mode driver.
> **Blue Team Impact**: Understanding SCM internals is the difference between simply seeing a "Service Started" log and identifying a **Privilege Escalation** or **Defense Evasion** attempt at the RPC level.

---

## 1. Core Architecture: The RPC Ledger
The SCM resides in the `%SystemRoot%\System32\services.exe` process. It functions as a centralized RPC server that manages the **Service Configuration Database**.

### 1.1 Communication & The MSRPC Bridge
* **Interface**: All management tools (sc.exe, services.msc, PsExec) communicate with SCM via **MSRPC** (specifically the `svcctl` interface).
* **Transport**: SCM listens on the named pipe `\pipe\svcctl` over SMB (Port 445).
* **The Orchestration**: When a remote service is created, the client performs an **MSRPC Handshake**, binds to the `svcctl` interface, and issues RPC commands (e.g., `Opnum 12` for `CreateServiceW`).

### 1.2 The Static Ledger (Registry)
The physical state of all services is stored in:
`HKLM\SYSTEM\CurrentControlSet\Services\<ServiceName>`
* **ImagePath**: The absolute path to the binary.
* **ObjectName**: The security principal used to run the service (e.g., `LocalSystem`, `NetworkService`).
* **Start**: Defines the boot behavior (2 = Auto, 3 = Manual, 4 = Disabled).

---

## 2. Service Startup Mechanics: Token Acquisition
When a service is triggered, SCM performs a critical sequence to establish the process's **Security Context**:

1.  **Impersonation**: SCM briefly impersonates the caller to verify permissions.
2.  **Logon Session Creation**: For services not running as `LocalSystem`, SCM communicates with **LSASS** to create a non-interactive logon session and retrieve an **Access Token**.
3.  **Process Spawning**: SCM calls `CreateProcessAsUser` (or `CreateProcessInternalW`) to launch the binary in **Session 0**, ensuring the new process inherits the correct token and privileges.

### Service Account Privilege Matrix
| Account | Network Identity | Privileges | Target Use Case |
| :--- | :--- | :--- | :--- |
| **LocalSystem** | Machine Account (`Host$`) | Highest (Full Access) | Core system components. |
| **Network Service** | Machine Account (`Host$`) | Low (User-like) | Network-facing services (e.g., DNS Client). |
| **Local Service** | Anonymous | Low (User-like) | Local background tasks. |

---

## 3. Security & Access Control (SDDL)
Every service object in the SCM database has its own **Security Descriptor**.

* **Registry Key**: `HKLM\SYSTEM\CurrentControlSet\Services\<ServiceName>\Security`
* **Mechanism**: This determines which users can `Start`, `Stop`, or `Modify` the service configuration. 
* **Attack Vector**: Adversaries often look for services with weak DACLs where a low-privileged user has `SERVICE_CHANGE_CONFIG` rights, allowing them to point the `ImagePath` to a malicious payload.

---

## 4. Kernel Interaction: Driver Management
SCM is responsible for loading **Kernel-Mode Drivers** (`.sys` files).
* **Type 1**: Services with `Type = 0x1` are kernel drivers.
* **Loading**: SCM uses the `NtLoadDriver` syscall to load these into **Ring 0**.
* **BYOVD Detection**: If SCM loads a driver from a non-standard path (e.g., `\Downloads\`) or a driver that triggers a **Code Integrity (CI)** violation, it is a high-confidence indicator of a **Bring Your Own Vulnerable Driver** attack.

---

## 5. Threat-Driven Defense (TDD) Perspective

### 5.1 Detection Matrix

| TTP | Event ID | Logic / Field to Watch |
| :--- | :--- | :--- |
| **Remote Service Creation** | **7045 (System)** | `ImagePath` in `\Temp` or `\AppData`. |
| **Service Tampering** | **Sysmon 13** | `services.exe` modifying `Start` or `ImagePath` keys. |
| **Privilege Escalation** | **4672 (Security)** | `SeDebugPrivilege` assigned to a service logon. |
| **MSRPC Lateral Movement** | **Sysmon 18** | Pipe connection to `\pipe\svcctl` from a non-admin source. |

### 5.2 Hunting Heuristics
* **Ghost Services**: Services with a `Start` type of `Auto` but no corresponding active process (may indicate a crashed or hidden rootkit).
* **Account Mismatch**: A service named "Windows Update" running as a standard **User Account** instead of `SYSTEM` or `NetworkService`.
* **Living-off-the-Land**: SCM being used to launch `cmd.exe` or `powershell.exe` directly via the `ImagePath`.