# COM Architecture & Registry Persistence (The Static Ledger)

> **Core Principle**: Component Object Model (COM) is the functional framework of Windows. The Registry acts as the "Static Ledger" used to index and activate these capabilities.

## 1. Core Identity IDs
* **GUID**: Global Unique Identifier; the universal "ID Card" for everything in Windows.
* **CLSID (Class ID)**: The **Functional ID**. Defines *what* the component does (e.g., "PDF Thumbnail Handler").
* **AppID (Application ID)**: The **Security Policy**. Defines *who* can run it and the **Access Token** context used.

## 2. Dynamic Activation Flow
When a program requests a COM object:
1. **The Order**: Calls `CoCreateInstance`.
2. **The Foreman**: **RPCSS (System Scheduler)** receives the request.
3. **The Audit**: RPCSS checks the Registry. It prioritizes **HKCU** (User) over **HKLM** (System).
4. **The Launch**: RPCSS loads the DLL or starts a **COM Surrogate** (`dllhost.exe`) based on the registry path.

## 3. Case Study: COM Hijacking (Chrysalis/Lotus Blossom)
* **Principle**: Adversaries write a malicious CLSID path into `HKCU\Software\Classes\CLSID`.
* **Inherited Trust**: Because `HKCU` is checked first, the system loads the malicious DLL instead of the legitimate one.
* **Security Context**: The malware inherits the security posture of the calling process (e.g., `explorer.exe`), avoiding "New Process" alerts.

## 4. Hunting Indicators
* **Registry Discrepancy**: Monitor for `HKCU` CLSID entries that duplicate or shadow legitimate `HKLM` entries.
* **Orphaned Surrogates**: Look for `dllhost.exe` instances loading unsigned DLLs from non-standard paths (Temp, AppData).