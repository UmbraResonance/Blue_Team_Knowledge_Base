# PEB (Process Environment Block) & TEB (Thread Environment Block)

> **Core Principle**: The PEB and TEB are user-mode data structures that the Kernel provides to processes/threads for fast metadata access. Because they reside in user-mode memory, they are prime targets for evasion and anti-analysis.

## 1. PEB (Process Environment Block)
The PEB contains process-wide information. It is accessed via the `gs` segment register (x64) or `fs` (x86).

### Key Fields for Attackers & Defenders:
* **BeingDebugged (Offset 0x2)**: A boolean flag set by the OS if a debugger is attached. Malware reads this directly (without calling `IsDebuggerPresent`) to self-terminate.
* **Ldr (InLoadOrderModuleList)**: A linked list of all DLLs loaded in the process. 
    * **Evasion**: Advanced malware can "unlink" itself from this list to become invisible to standard enumeration tools (e.g., `tasklist` or Process Explorer).
* **ProcessParameters**: Contains the command line and environment variables.

## 2. TEB (Thread Environment Block)
The TEB stores information about the currently running thread.
* **StackBase / StackLimit**: Defines the thread's memory stack boundaries.
* **TlsSlots**: Thread Local Storage; used by malware to store persistent data across function calls without using global variables.

## 3. Hunting & Forensic Insights
* **Static Analysis**: Search for assembly instructions like `mov rax, gs:[60h]` (PEB) or `mov rax, gs:[30h]` (TEB). These are strong indicators of manual environment inspection or anti-debugging logic.
* **Memory Forensics**: Compare the PEB's module list with the Kernel's `EPROCESS` list. Any discrepancy (a DLL in the Kernel list but not in the PEB) indicates **Module Unlinking** evasion.