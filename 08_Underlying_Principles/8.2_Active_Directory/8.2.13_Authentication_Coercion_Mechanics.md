# Authentication Coercion Mechanics

## 1. Description
Authentication Coercion is a technique where an attacker abuses legitimate Windows RPC interfaces to force a remote system—most critically a Domain Controller (DC)—to initiate an outbound authentication request toward an attacker-controlled listener. This "one-stop shop" for escalating privileges allows any domain user to coerce RemoteServer$ to authenticate to any machine in the domain. This "callback" typically uses the system's Machine Account (`Server$`), providing a high-privileged credential for NTLM Relaying or Kerberos Delegation attacks.

## 2. Attack Surface and Vectors
The following protocols provide the primary mechanics for coercion. While specific scripts target individual protocols, the Coercer tool was developed to exploit all known vulnerable RPC functions simultaneously:

| Vector | Protocol | RPC UUID | Primary Function |
| :--- | :--- | :--- | :--- |
| **PrinterBug** | MS-RPRN | `12345678-1234-abcd-ef00-0123456789ab` | `RpcRemoteFindFirstPrinterChangeNotificationEx` |
| **PetitPotam** | MS-EFSR | `c681d588-428e-4515-97a9-24b91903747f` | `EfsRpcOpenFileRaw` |
| **ShadowCoerce**| MS-FSRVP | `a8e0653c-2744-4389-a61d-7373df8b2292` | `IsPathShadowCopied` |

## 3. Underlying Logic
The vulnerability stems from "Insecure by Design" features rather than implementation bugs:
* **Asymmetric Trust**: The target server trusts the RPC request to perform an action (like printer notification or file encryption) and must prove its own identity to the destination specified in the request.
* **Lack of Mutual Authentication**: Legacy RPC calls do not always verify the identity of the requester before initiating the callback.
* **NTLM Fallback**: In cross-segment or unmanaged environments, systems often fallback to NTLM, which is susceptible to relaying.

## 4. Exploitation and Follow-up Options

After triggering the coercion (e.g., using dementor.py or Coercer), an attacker can choose from several "follow-up" options via the reverse connection:
* **Relay to DCSync:** Relay the connection to another DC and perform DCSync if SMB Signing is disabled.
* **Unconstrained Delegation (UD):** Force the Domain Controller to connect to a machine configured for Unconstrained Delegation. This will cache the TGT in the memory of the UD server, which can be captured or exported with tools like Rubeus and Mimikatz.
* **Relay to Active Directory Certificate Services (AD CS):** Relay the connection to AD CS (typically HTTP endpoints) to obtain a certificate for the Domain Controller. This certificate can be used on-demand to authenticate and pretend to be the DC (e.g., for DCSync).
* **Relay for Resource-Based Constrained Delegation (RBCD):** Relay the connection to configure RBCD for the relayed machine. Attackers can then abuse the delegation to authenticate as any Administrator to that machine.

## 5. Technical Distinction: Relay vs. Replay

Understanding the difference between Relay and Replay is critical for both exploitation and detection engineering.

| Feature | Replay Attack | NTLM Relay Attack |
| :--- | :--- | :--- |
| **Nature** | **Asynchronous / Static**. Capture now, use later. | **Synchronous / Dynamic**. Real-time Man-in-the-Middle (MITM). |
| **Challenge Sync** | Fails because the server issues a new, random 8-byte nonce (Challenge) for every session. | Succeeds by intercepting the target's Challenge and forwarding it to the victim in real-time. |
| **Viability** | Generally impossible in modern AD due to NTLM's "Challenge-Response" design. | Highly effective as it bypasses the randomness of the Challenge through synchronization. |

### 5.1 The Real-Time Logic (The "Messenger" Principle)
The success of a relay attack depends on maintaining two concurrent TCP sessions:
1. **Victim Session**: Initiated via Coercion (e.g., DC calling back to the attacker).
2. **Target Session**: Initiated by the attacker toward the intended resource (e.g., AD CS or another DC).

The attacker acts as a transparent messenger:
* **Step 1**: Target Server sends a **Type 2 (Challenge)** to the Attacker.
* **Step 2**: Attacker immediately forwards this specific Challenge to the Victim.
* **Step 3**: Victim calculates the **Type 3 (Authenticate)** based on the Target's Challenge and sends it to the Attacker.
* **Step 4**: Attacker forwards this valid Response back to the Target Server to complete the authentication.

### 5.2 Why it Bypasses "Insecure by Design" Controls
Standard NTLM does not bind the authentication to the underlying secure channel (unless **EPA/Channel Binding** is enabled). Therefore, the Target Server sees a valid response to its challenge and assumes it is talking directly to the Victim, unaware that the response was "outsourced" via the attacker.

## 6. References
* [MS-RPRN]: Print System Remote Protocol
* [MS-EFSR]: Encrypting File System Remote (EFSRPC) Protocol