# Kerberos Delegation Mechanics

## 1. Overview
Kerberos Delegation allows a service to impersonate a user to access other network resources. While essential for multi-tier applications, misconfigurations create critical attack vectors.

## 2. Delegation Types & Risks

### 2.1 Unconstrained Delegation (UD)
- **Mechanism**: The user's TGT is sent to the service and cached in its LSASS memory.
- **Risk**: If the service is compromised, attackers can extract the TGT and impersonate the user across the entire domain.
- **Attack Vector**: **Coercion Attacks** (PrinterBug/PetitPotam) force high-privileged accounts (like Domain Controllers) to authenticate to a UD-enabled host.

### 2.2 Constrained Delegation (KCD)
- **Mechanism**: Restricted by the `msDS-AllowedToDelegateTo` attribute, which specifies the target SPNs the service can access.
- **Protocol Transition (S4U2self)**: Allows a service to request a ticket for a user even if the user didn't authenticate via Kerberos.
- **Attack Vector**: If an attacker compromises a service account with `TrustedToAuthForDelegation` enabled, they can impersonate any user to the authorized backend SPNs using Rubeus `s4u`.

### 2.3 Resource-Based Constrained Delegation (RBCD)
- **Mechanism**: The trust is defined on the **resource** side via the `msDS-AllowedToDelegateToAccount` attribute (storing SIDs of trusted services).
- **Security Boundary**: Unlike KCD, it does not require Domain Admin privileges to configureâ€”anyone with `GenericWrite` over a computer object can set this.
- **Attack Vector**: Attackers create a fake machine account (leveraging `ms-DS-MachineAccountQuota`) and add its SID to the target's RBCD attribute to gain administrative access.

## 3. Detection Engineering (Blue Team Perspective)

### 3.1 The "Transited Services" Smoking Gun
In Event 4624 (Logon Type 3), the **Transited Services** field records the service that requested the ticket on behalf of the user. In a typical attack (e.g., Rubeus s4u), this field will contain the service account name used as the delegation jump-point.

### 3.2 Machine Account Quota (MAQ) Monitoring
Monitor **Event 4741** for machine accounts created by standard users. If MAQ is not 0, this is the primary indicator of an ongoing RBCD attack preparation.

## 4. Mitigation Strategies
- **Set MAQ to 0**: Prevents standard users from creating machine accounts for RBCD.
- **Protected Users Group**: Members of this group cannot be delegated, neutralizing most delegation attacks.
- **Account is Sensitive**: Flagging high-privileged accounts as "sensitive and cannot be delegated" in AD.

---
**References**:
- [1.1_Master_Hunting_Matrix](../../01_Hunting_Cheatsheets/1.1_Master_Hunting_Matrix.csv)
- [1.3_Windows_Event_Core](../../01_Hunting_Cheatsheets/1.3_Windows_Event_Core.md)
- [8.2.06_Kerberos_Protocol_and_Encryption.md](./8.2.06_Kerberos_Protocol_and_Encryption.md)