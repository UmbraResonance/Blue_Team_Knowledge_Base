# Kerberos Protocol and Encryption Logic

## Overview
Kerberos security relies on the secrecy of Long-Term Keys derived from user/service passwords. This document bridges the gap between cryptographic theory and the Kerberoasting attack vector.

## The Key Derivation Process (String-to-Key)
When a password is set, it is converted into a cryptographic key using a **String-to-Key (S2K)** function. The protocol does not use the plaintext password for encryption.

### 1. Modern Encryption (AES-128/256)
Modern AD environments use **PBKDF2** (Password-Based Key Derivation Function 2).
- **Mechanism:** $Key = PBKDF2(HMAC-SHA1, Password, Salt, Iterations)$
- **Salt:** A combination of the Domain Name and Username (e.g., `CORP.LOCALusername`).
- **Iterations:** Typically 4,096. This "stretches" the password, making offline brute-force significantly slower than legacy NTLM hashes.

### 2. Legacy Encryption (RC4-HMAC)
- **Mechanism:** The key is simply the **NTLM Hash** of the password (MD4).
- **Vulnerability:** No salt, no iterations. This makes RC4-encrypted tickets (Type 0x17) extremely fast to crack using modern GPUs.

## Why Kerberoasting Works
The **Enc-Part** (Encrypted Part) of a TGS-REP (Service Ticket) is encrypted using the **Service Account's Long-Term Key**.
1. **The Request:** Any authenticated domain user can request a TGS ticket for any service with an SPN.
2. **The Response:** The KDC (Domain Controller) returns a ticket encrypted with the service account's key.
3. **The Attack:** Since the encryption happens offline on the attacker's machine, they can use the **Honey-Cracking** logic: iterate through billions of passwords, derive the key, and check if it decrypts the ticket's checksum.

## Detection Engineering Logic
### 1. High-Entropy vs. Low-Entropy
- **Fact:** A 25+ character random password is mathematically uncrackable via Kerberoasting.
- **Hunting Tip:** Focus on accounts with `adminCount=1` but legacy SPNs.

### 2. The Honey SPN Strategy
By creating an SPN for a non-existent service, we turn the attacker's "blind request" into a high-fidelity alert.
- **Logic:** Request for `ServiceName: HoneyUser` -> `Severity: Critical`.

## References
- [1.1_Master_Hunting_Matrix](../01_Hunting_Cheatsheets/1.1_Master_Hunting_Matrix.csv) (Detection Logic)
- [1.3_Windows_Event_Core](../01_Hunting_Cheatsheets/1.3_Windows_Event_Core.md) (Event 4769 Detail)