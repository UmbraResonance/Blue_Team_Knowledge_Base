# NTLM Authentication Mechanism and 4776 Logic

## Overview
While Kerberos is the preferred authentication protocol in modern Active Directory environments, NTLM (New Technology LAN Manager) remains a critical fallback for legacy systems, non-domain joined devices, and IP-based connections. For a defender, understanding NTLM is vital because it lacks mutual authentication and is highly susceptible to Relay and Pass-the-Hash attacks.

## The Three-Way Handshake (Challenge-Response)
NTLM does not send the password over the network. Instead, it uses a three-step cryptographic exchange:

1. **NEGOTIATE_MESSAGE**: The client sends a list of supported NTLM versions and capabilities to the server.
2. **CHALLENGE_MESSAGE**: The server responds with an **8-byte random number**, known as the **Server Challenge** (Nonce).
3. **AUTHENTICATE_MESSAGE**: 
   - The client encrypts the Server Challenge using their **NTLM Hash** (derived from the password).
   - This result is the **Response**. The client sends this, along with their username and domain, back to the server.

## Pass-Through Authentication (The Role of Netlogon)
When a user logs into a member server using a domain account:
1. The **Member Server** cannot verify the Response because it does not store the user's NTLM hash.
2. The server sends the Challenge and the Response to a **Domain Controller (DC)** via a **Netlogon secure channel**.
3. The DC looks up the user's NTLM hash in the `NTDS.dit` database, recalculates the expected response, and compares it.
4. **The DC triggers Event 4776** to record the success or failure of this credential validation.

## Attack Vectors: Why NTLM is Still a Target

### 1. NTLM Relay (T1557.001)
Since NTLM lacks a timestamp or session-binding in the challenge, an attacker can capture a victim's `AUTHENTICATE_MESSAGE` and forward (relay) it to another server (e.g., SMB or HTTP) to gain unauthorized access as that user.

### 2. Pass-the-Hash (T1550.002)
Because the "Response" is derived directly from the NTLM hash, an attacker who steals the hash from memory (LSASS) can authenticate to any NTLM-enabled service without ever knowing the plaintext password.

## Detection Engineering Logic

### 1. Identifying Downgrade Attacks
- **Logic:** Monitor for successful **Event 4776** logs for sensitive accounts (Domain Admins) that should strictly use Kerberos.
- **Goal:** Detect attackers forcing NTLM authentication to facilitate Relay or PtH.

### 2. Brute Force & Spraying (Event 4776)
- **Fact:** 4776 is the primary sentinel on the DC for NTLM-based spraying.
- **Key Error Codes:**
    - `0xC000006A`: Bad password.
    - `0xC0000064`: Non-existent user (Username Enumeration).
    - `0xC0000072`: Account Disabled. (Compare with **Event 4725** for administrative status changes).

### 3. Source Workstation Spoofing
- **Hunting Tip:** If the `Source Workstation` in 4776 does not match the `Source Network Address` in the corresponding **Event 4624/4625** on the target server, it is a high-fidelity indicator of an attacker attempting to hide their origin.

## References
- [1.3_Windows_Event_Core](../../01_Hunting_Cheatsheets/1.3_Windows_Event_Core.md) (Logon Events Detail)
- [1.4_Network_Protocol_Filters](../../01_Hunting_Cheatsheets/1.4_Network_Protocol_Filters.csv) (NTLM Wireshark Filters)
- [8.2.06_Kerberos_Protocol_and_Encryption](./8.2.06_Kerberos_Protocol_and_Encryption.md) (Protocol Comparison)