# Active Directory ACL Principles

> **Core Concept:** Unlike the flat file-system permissions, AD ACLs govern access to logical directory objects and their specific attributes, forming the foundation of Identity-based security.
> **Blue Team Impact:** Misconfigured AD ACEs are the root cause of "Shadow Admins" and enable complex privilege escalation paths like RBCD and GPO Abuse.

---

## 1. Technical Architecture: The Directory vs. The Host

AD ACLs operate within the `ntds.dit` database on Domain Controllers. While they share the "Security Descriptor" structure with local objects, the operational logic is specialized for directory services.

### **1.1 Identity vs. Resource Mapping**
* **Identity Governance**: AD manages the "Identity" (SIDs).
* **Resource Governance**: The Local Host manages the "Resource" (the ACL entry referencing those SIDs).
* **AD Objects**: When modifying an AD object, you are interacting with the **NTDS.exe** process, which validates your Access Token against the object's DACL stored in the directory.

### **1.2 Property-Level Granularity**
In NTFS, you usually grant access to a whole file. In AD, permissions can be stripped down to specific attributes:
* **ReadProperty / WriteProperty**: Permission to interact with specific fields like `mobile`, `memberOf`, or `servicePrincipalName`.
* **Extended Rights**: Actions that aren't simple Read/Write, such as **"Reset Password"** or **"Send As"**.

---

## 2. AD-Specific Inheritance & Flags

Inheritance in AD is more complex than in NTFS due to the object-class hierarchy.

* **Object-Specific ACEs**: An ACE can be set to only apply to `User` objects within an OU, ignoring `Computer` or `Group` objects.
* **Inheritance Flags**:
    * **`CI` (Container Inherit)**: Applies to sub-containers.
    * **`ID` (Inherited)**: Indicates the ACE was not set directly on the object.
* **Blue Team Note**: Attackers often look for objects where "Inheritance is Disabled," as these are often "Protected Groups" (like Domain Admins) or manually hardened accounts that might have inconsistent permissions.

---

## 3. High-Risk Permissions (The "Kill Chain" Indicators)

| Permission | Technical Risk | Attack Scenario |
| :--- | :--- | :--- |
| **GenericAll** | Full Control. | Password reset, takeover, or adding a malicious SPN. |
| **WriteDACL** | Permission Modification. | An attacker grants themselves `GenericAll` to ensure persistence. |
| **WriteProperty (on SPN)** | Attribute Manipulation. | Enabling **Kerberoasting** by assigning an SPN to a high-privileged user. |
| **AllExtendedRights** | Functional Control. | Ability to perform "Reset Password" or "Force Change Password." |

---

## 4. Telemetry & Detection Engineering

Monitoring AD ACL changes is critical for detecting **Defense Evasion (T1562.002)** and **Privilege Escalation (TA0004)**.

### **4.1 Key Event IDs**
* **Event ID 5136 (Directory Service Object Modified)**: The "Gold Standard" for AD changes.
    * **Focus**: Look for changes to the `nTSecurityDescriptor` attribute.
    * **Context**: Pivot using the `SubjectLogonId` to find the original **Event 4624** (Look for Logon Type 3 for remote abuse).
* **Event ID 4662 (Object Access)**: Generated when an operation is performed on an AD object.

### **4.2 Detection Logic: "The Shadow Admin"**
1. **Trigger**: Event ID 5136 where `AttributeName` is `nTSecurityDescriptor`.
2. **Analysis**: Compare `OldValue` and `NewValue` (SDDL format).
3. **Red Flag**: A non-administrative `Subject` adding an `Allow` ACE for themselves or a suspicious SID (e.g., a newly created user).

---

## Related References
- [[8.1.1_Object_Security_SACL]]: Core Security Descriptor theory.
- [[8.1.2_Access_Tokens]]: Understanding the Subject's context.
- [[8.2.08_GPO_Delegation_and_Abuse_Logic]]: Practical application of AD ACLs in GPO hierarchies.