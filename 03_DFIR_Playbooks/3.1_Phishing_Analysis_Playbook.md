# 3.1 Phishing Analysis Playbook (Tactical)

> **Goal:** Complete analysis from email header to malicious payload extraction.
> **Role:** BTL1 / SOC Analyst.
> **Output:** True Sender IP, Malicious URL, Attachment Hash/Payload.

---

## Phase 1: Header Analysis (The Source)

*Identify the TRUE origin. Do not trust the "From" field.*

### 1. Extract Artifacts

- [ ] **Return-Path:** Does it match the `From` address?
- [ ] **Subject Line:** Note for searching other mailboxes.
- [ ] **Message-ID:** Unique ID for Splunk/Exchange logs.

### 2. Trace the IP (Bottom-Up)

*Look at the `Received` headers. Start from the BOTTOM (oldest).*

1.  Ignore internal hops (e.g., 10.x.x.x, 192.168.x.x).
2.  Find the **first public IP** that handed the email to your gateway.
3.  **Check:** Is there an `X-Originating-IP` header? (If yes, this is the smoker gun).

### 3. Verify Authentication

- [ ] **SPF:** `Pass` or `Fail`? (Softfail = Suspicious).
- [ ] **DKIM:** `Pass` or `Fail`?
- [ ] **DMARC:** What is the policy? (Quarantine/Reject/None).

---

## Phase 2: Body & URL Analysis (The Vector)

*Analyze links without clicking.*

### 1. Extract & Defang

*Never copy a live link into a ticket. Defang it first.*

* **CyberChef:** `Defang URL` recipe.
    * `http://evil.com/login` -> `hxxp[:]//evil[.]com/login`

### 2. URL Inspection (Static)

* **Visual Check:** Is it Typosquatting? (e.g., `microsaft.com`).
* **Redirects:** Does the text say "LinkedIn" but the link goes to `bit.ly`?

### 3. Reputation Check (OSINT)

* **VirusTotal / URLScan.io:** Check the domain/IP.
* **Browser Sandbox (Any.run):** *Only if allowed by ROE.*

---

## Phase 3: Attachment Forensics (The Payload)
*The critical BTL1 technical step. Extract the IOCs manually.*

### Scenario A: Office Docs (Macros)

*Tools: `oledump.py`*

**Step 1: Identify Macros**
```bash
oledump.py <FILE>
# Look for streams with 'M' (e.g., "8: M").
```

**Step 2: Extract VBA Code**
```bash
oledump.py -s <STREAM_NUM> -v <FILE> > macro.vba
# Example: oledump.py -s 8 -v invoice.docm > macro.txt
```

***Step 3: Analyze Logic (Deobfuscation)***

- Search for keywords: AutoOpen, Shell, CreateObject, http, powershell.
- CyberChef Strategy:
    - If you see Base64 strings: From Base64 -> Remove Null Bytes.
    - If you see Chr(65): From Charcode.

### Scenario B: Archives (ZIP/ISO)

*Tools: 7z, Get-FileHash*

**Step 1: Extract Safely**
```bash
7z l <FILE>  # List contents first!
7z x <FILE> -o Analysis_Folder
```

**Step 2: Hash the Payload Don't just hash the ZIP.**
```bash
sha256sum <EXTRACTED_FILE>
md5sum <EXTRACTED_FILE>
```

**Step 3: Identify File Type**
```bash
file <EXTRACTED_FILE>
# Confirm if it's PE32 executable, script, or another archive.
```

### Scenario C: PDF Analysis

*Tools: pdfid.py, pdf-parser.py*

**Step 1: Scan for JS/Actions**
```bash
pdfid.py <FILE>
# Suspicious keywords: /JS, /JavaScript, /AA, /OpenAction
```

**Step 2: Extract Content**
```bash
# Search for the object containing JavaScript
pdf-parser.py --search javascript <FILE>

# Dump the specific object (replace <OBJECT_ID> with the ID found above)
pdf-parser.py --object <OBJECT_ID> --filter --raw <FILE> > output.js
```

### ðŸ›‘ Decision Point: Binary Payload Found?
*If the attachment drops or contains a compiled binary (EXE/DLL/ELF):*
1.  **Hash it:** Record the SHA256.
2.  **Pivot:** Proceed to malware analysis related playbook for detailed static/dynamic analysis.
3.  **Stop Here:** Do not attempt to reverse engineer the binary within the Phishing workflow.

## Phase 4: Containment & Reporting
Close the loop.

### 1. Immediate Actions

- [ ] Block Sender: Block the Envelope Sender (Return-Path) and Source IP.

- [ ] Block URL/Domain: Add to Web Proxy/DNS Sinkhole.

- [ ] Purge: Search Subject/Message-ID and delete from inboxes.

2. Record & Report Artifacts
| Artifact Type | Value (Defanged) | Context |
| :--- | :--- | :--- |
| **Sender IP** | `[Source_IP]` | Extracted from Received headers. |
| **Sender Email**| `[Return_Path]` | From Return-Path header. |
| **Malicious URL**| `hxxp[:]//...` | Found in email body/macro. |
| **Payload Hash**| `[SHA256]` | Hash of the extracted attachment. |

