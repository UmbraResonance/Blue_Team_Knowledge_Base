# 3.1 Phishing Analysis Playbook (Universal)

> **Goal:** Complete analysis from email header to malicious payload extraction and threat intelligence pivot.
> **Role:** SOC Analyst.
> **Output:** True Sender IP, Malicious URL, Payload Hashes, and Targeted Recipients.

---

## Phase 1: Header Analysis (The Source)
*Identify the TRUE origin of the email and verify its authenticity.*

### 1. Artifact Extraction
* **Action**: Extract key header fields including `Return-Path`, `Received`, `X-Originating-IP`, and `Message-ID`.
* **Logic**: Check if the `Return-Path` matches the `From` address to detect spoofing.
* **Vault Link**: Use Linux text-processing utilities (grep/awk) to parse headers in bulk, as detailed in [`6.4_Linux_Live_Analysis`](../06_Tool_Command_Vault/6.4_Linux_Live_Analysis.md).

### 2. IP Traceability & Authentication
* **Action**: Trace the `Received` chain bottom-up to find the first public IP and review SPF/DKIM/DMARC results.
* **Hunting Link**: Reference [`1.3_Network_Protocol_Filters`](../01_Hunting_Cheatsheets/1.3_Network_Protocol_Filters.csv) for SMTP verification status.

---

## Phase 2: Body & URL Analysis (The Vector)
*Analyze links and call-to-action triggers safely.*

### 1. Extraction & Defanging
* **Action**: Extract all URLs and defang them (e.g., `hxxp[:]//`) to prevent accidental execution.
* **Vault Link**: Use native CLI decoding methods (e.g., `base64 -d`) defined in [`6.1_General_DFIR_Commands`](../06_Tool_Command_Vault/6.1_General_DFIR_Commands.md).
* **CyberChef Logic**: Use "URL Detach" and "Defang URL" recipes to sanitize the vector.

---

## Phase 3: Attachment Forensics (The Payload)
*Extracting Indicators of Compromise (IOCs) from suspicious files.*

### 1. Office Document Analysis (OLE/Macros)
* **Step A: Scan for Macros**
    `python3 oledump.py <filename>`
    *Look for the 'M' (Macro) or 'm' (Attributes) indicators next to streams.*
* **Step B: Select and Dump Stream**
    `python3 oledump.py -s <stream_number> -v <filename>`
    *The `-v` flag decompresses the VBA source code for analysis.*
* **Step C: Targeted Search**
    `python3 oledump.py -s <stream_number> -v <filename> | grep -Ei 'shell|noke|exe|http|createobject'`

### 2. PDF Forensics
* **Step A: Initial Triage**
    `python3 pdfid.py <filename>`
    *Check for counts > 0 in `/JS`, `/JavaScript`, `/OpenAction`, or `/EmbeddedFile`.*
* **Step B: Structural Search**
    `python3 pdf-parser.py --search /JavaScript <filename>`
* **Step C: Dump Object Content**
    `python3 pdf-parser.py -o <object_number> -d <output_file> <filename>`

### 3. Archive Extraction & Integrity
* **Vault Link**: Use [`6.1_General_DFIR_Commands`](../06_Tool_Command_Vault/6.1_General_DFIR_Commands.md) for 7z extraction (e.g., `7z x <file> -p<password>`) and SHA256 calculation (`certutil -hashfile <file> SHA256`).

---

## Phase 4: Containment & Reporting
*Eradicate the threat and pivot to proactive hunting.*

### 1. Detection Pivot
* **Vault Link**: Apply [`6.7_Splunk_SPL_Syntaxes`](../06_Tool_Command_Vault/6.7_Splunk_SPL_Syntaxes.md) to correlate endpoint traffic with discovered malicious IPs/Domains.
* **Reporting Link**: Record all hashes in [`7.2_Evidence_Artifact_Log`](../07_Reporting_Templates/7.2_Evidence_Artifact_Log.csv).

---

## üîç Analytical QA (Self-Check)
* **[ ]** Did I check the `X-Originating-IP` header for the attacker's true source?
* **[ ]** Have I mapped behaviors to MITRE TTPs (e.g., T1566.001 - Phishing: Spearphishing Attachment)?
* **[ ]** Are all payloads hashed and logged for Chain of Custody?